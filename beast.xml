<tool id="ARGO_beast_run" name="Run Beast" version="1.0.0">
  <description>Perform a discrete trait ancestral reconstruction analysis (al a Migrate) using BEAST</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <command interpreter="bash">
    beast.sh ${config}
  </command>
  <stdio>
    <expand macro="basic_errors"/>
  </stdio>
  <inputs>

    <!--XXX need to make this optional-->
    <param name="alignment" type="data" format="fasta" label="Sequence alignment"/>

    <!--XXX Here assuming that either you enter deme/date with regexp, or with csv metadata, or directly through BEAST xml; no mixing-->
    <conditional name="meta_specification">
      <param name="meta_specification_selector" type="select" label="Metadata specification"
        help="BEAST needs to know how sequences should be split up into groups, and if samples have dates associated
        with them, how to get this data. You can either pass along a specification CSV file, or specify regular
        expressions for extrating this data from sequence names.">
        <option value="spec_file" selected="true">Deme spec file</option>
        <option value="regexp">From sequence names</option>
        <option value="in_beastfile">Use mappings present in specified BEAST XML file</option>
      </param>
      <when value="spec_file">
        <param name="metadata_file" type="data" format="csv" label="Metadata file"
          help="CSV file specifying deme and (optionally) date data."/>
        <!--XXX have to add fields here specifying what columns to grab-->
      </when>
      <!--XXX - Have to tune these regular expressions-->
      <when value="regexp">
        <param name="deme_regexp" type="text" value="[^\s\|]+|(.+)" label="Deme name regular expression"
          help="Defaults to second value in a 2-ple or triple of '|' separated values."/>
        <!--XXX make sure this is optional; also make sure that the clock rate specification forks on this-->
        <param name="date_regexp" type="text" value="[^\s\|]+\|[^\s\|]+\|(.+)" label="Date regular expression"
          help="This regular expression should extract an integer value, which can be interpetted as a time value.
          Whether it is years, months, days (etc.) is up to you."/>
      </when>
      <when value="in_beastfile">
        <!--Nothing-->
      </when>
    </conditional>

    <!--XXX Be able to refer to these as a collection of related settings?-->
    <!--XXX - Add some help here giving time estimates and such-->
    <param name="samples" type="integer" value="10000" label="Random seed" min="100"
      help="Number of samples to keep out of chain."/>
    <!--XXX Will have to check to make sure logging frequency is the same between -resume runs-->
    <param name="sampling_interval" type="integer" value="1000" label="Random seed" min="1"
      help="Number of states explored in chain between samples. Note that if doing a resume run, this number must be
      the same as that of the prior run."/>

    <!--XXX Is it possible to make the default template just a regular data set file? That would make it easy to download ph?-->
    <!--Could it stil be linked to easily below?-->
    <param name="beastfile_template" type="data" format="xml" label="BEAST file XML template"
      help="If all sequence, deme, and temporal data is present in this file, only the chain length settings above need
      be specified. Any sequence, deme or temporal data specified above will be taken in preference to whatever is in
      this file. Any customization of models or priors should be specified through this file. See below for details."/>

    <!--XXX Be able to refer to these as a collection of related settings?-->
    <!--XXX need to make this optional, but also make sure both are together or errors-->
    <param name="resume_logfile" type="data" format="txt" label="Logfile from last run; triggers -resume run"/>
    <param name="resume_treefile" type="data" format="txt" label="Treefile from last run; triggers -resume run"/>

    <!--XXX Really need to make this not require a value so it's random between multiple runs...-->
    <param name="random_seed" type="integer" value="" label="Random seed" min="2"
      help="Random seed to be used in BEAST MCMC. Specifying and recording this value can aid in reproducibility."/>

  </inputs>

  <!--XXX Need to make sure we have the right formats here; in particular, there is probably a nexus format, and maybe the-->
  <!--logfile would work with tabs, but maybe there are more specific types accepted for both these. Or maybe we should add-->
  <!--them?-->
  <outputs>
    <data name="logfile" format="txt" label="Argo BEAST logfile"/>
    <data name="treefile" format="txt" label="Argo BEAST treefile"/>
  </outputs>

  <configfiles>
    <!-- XXX Not sure if these deme specifications will actually work or not ??? -->
    <configfile name="config">

#if $alignment == ""
ALIGNMENT_FLAG="-a ${alignment}"
#else
ALIGNMENT_FLAG=""
#end if

META_SPECIFICATION_SELECTOR="${meta_specification.meta_specification_selector}"
META_SPECIFICATION_FILE="${meta_specification.spec_file}"

DEME_REGEX_FLAG="-d ${meta_specification.deme_regex}"

#if $meta_specification.date_regex == ""
DATE_REGEX_FLAG=""
#else
DATE_REGEX_FLAG="-t ${meta_specification.date_regex}"
#end if

SAMPLES_FLAG="-s ${samples}"
SAMPLING_INTERVAL_FLAG="-i ${sampling_interval}"

BEASTFILE_TEMPLATE="${beastfile_template}"

RESUME_LOGFILE="${resume_logfile}"
RESUME_TREEFILE="${resume_treefile}"

#if $meta_specification.date_regex == ""
DATE_REGEX="-t ${meta_specification.date_regex}"
#else
DATE_REGEX=""
#end if
RANDOM_SEED="${random_seed}"

LOGFILE="${logfile}"
TREEFILE="${treefile}"
    </configfile>
  </configfiles>

  <!-- The contents of the help tag is parsed as reStructuredText. Please see
       help-template.rst for examples of commonly-used sections in other Galaxy
       tools. -->
  <help>

.. class:: infomark

What it does
------------

This runs BEAST for an Argo Navis analysis.
The inline help should clarify what is required for this tool.


Output files
------------

This tool outputs two files representing the posterior of distribution of evolutionary histories and ancestral trait states.

**Argo BEAST logfile**: A standard BEAST logfile of sampled states and parameters, suitable for being run through tracer.

**Argo BEAST treefile**: A nexus file of trees from the posterior, with ancestral states labeled. This is suitable for
being run through PACT.

Note that if you run BEAST a number of time in ``-resume`` mode (see above), these output files may become large enough
to significantly slow down Tracer and PACT.
If this becomes a problem, you can use the Posterior Subset Tool to reduce the size of these files.

Do note that it's important that you check your logfile for good mixing and convergence using a tool like `Tracer`_, or
your analyses will basically mean nothing.


Fine tuning
-----------

If you'd like to customize more fine tuned settings of the BEAST MCMC (models, priors, etc), you can do so by specifying
a custom BEAST file template.
The default template closely follows the setup in the `Ancestral State Reconstruction tutorial`_ by Remco Bouckaert,
which you can use as a guide for setting up your own custom BEAST analysis.
You can also download the default template XXX here and make modications from that.
However you should keep in mind that if you use BEAUti to make your customizations, you'll need to follow some of the
early steps in Remco's tutorial in order to get BEAST Classic set up with BEAUti.
Frome there, you can download the default template, and load it by firing up BEAUti and going to "File > Load".
Also, note that for additional assistance working with and tuning BEAST, the `BEAST homepage`_ is a great resource.

Some notes to keep in mind if you specify your own BEAST template from scratch:

* If you choose to specify the deme/community information directly in the your BEAST file and not apply the CSV or regular
  expression data to set this, you must name your discrete trait `deme`, even if it's not deme, but something else, like
  species name or tissue type.
* Note that the chain length and sampling interval settings in your beastfile will get overriden by whatever is specified
  here in this tool, and can not be assumed to remain as specified in your beastfile.
* If you don't have tip dates, you can speed up your run by specifying a custom beast file where your fixed clock's rate isn't
  estimated but left constant. If you don't have any temporal data, these estimates won't mean anything anyway.
* Main logfile must output to ``posterior.log`` and the trait trees to ``posterior.trait.trees``.

.. _Tracer: http://tree.bio.ed.ac.uk/software/tracer/
.. _Ancestral State Reconstruction tutorial: http://beast-classic.googlecode.com/files/ARv2.0.1.pdf
.. _BEAST homepage: http://beast-classic.googlecode.com/files/ARv2.0.1.pdf


Citation
--------

Should cite the upcoming AstV paper and BEAST and Trevor's flu paper


  </help>
</tool>
