<tool id="ARGO_pact_run" name="Run PACT" version="1.0.0">
  <description>Analyze Argo Navis BEAST run using PACT</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <command interpreter="bash">
    pact.sh ${config}
  </command>
  <stdio>
    <expand macro="basic_errors"/>
  </stdio>
  <inputs>

    <!--XXX need to make this optional-->
    <param name="treefile" type="data" format="txt" label="BEAST treefile"
      help="This should be the 'BEAST treefile' from your most recent run of BEAST.
      If you did a 'Resume' run, you should use the 'Trimmed' treefile."/>

    <conditional name="tip_selection">
      <param name="method" type="select" label="Tip selection method"
        help="You may optionally choose to restrict these PACT analyses to a subset of the sequences.
        By default, all tips are included in the analysis.">
        <option value="all" selected="true">All tips (no subsetting)</option>
        <option value="deme">Select By Deme</option>
        <option value="names">Space separated tip names</option>
        <option value="file">Tip name file</option>
      </param>
      <when value="deme">
        <param name="deme" type="text" value="" label="Deme" help="Restrict analyses to the specified deme."/>
      </when>
      <when value="names">
        <param name="tip_name" type="text" value="" label="Tip names"
          help="Restrict analyses to the specified tip names (space separated)."/>
      </when>
      <when value="file">
        <param name="file" type="data" format="txt" label="Tip names file"
          help="A file with one tip name per line."/>
      </when>
    </conditional>

    <conditional name="time_range">
      <param name="selector" type="select" label="Time range"
        help="As with the Tip selection, you have the choice of restricting the anlayses to a particular time
        range wihtin the tree.">
        <option value="all" selected="true">Don't restrict time range</option>
        <option value="mrca">Time to MRCA of selected tips</option>
        <option value="custom">Custom time range</option>
      </param>
      <when value="custom">
        <param name="start" type="float" value="1.0" label="Start time"
          help="The age of the oldest ancestry which should be considered (as a positive number)."/>
        <param name="end" type="float" value="0.0" label="End time"
          help="The age of the most recent ancestry which should be considered (as a non-negative number)."/>
      </when>
    </conditional>

    <conditional name="color">
      <param name="selector" type="select" label="Color specification"
        help="By default, the colors used in plots are automatically chosen for you.
        However, you can either specify your own semi-automatic color scheme using Colorbrewer, or
        for full control a CSV file mapping demes to colors.">
        <option value="brewer" selected="true">Color brewer spec</option>
        <option value="file">Color spec file</option>
      </param>
      <when value="brewer">
        <param name="brewer" type="text" value="RdBu" label="Deme and optionally date information"
          help="A valid colorbrewer2 color scheme name. See http://colorbrewer2.org/ for details."/>
      </when>
      <when value="file">
        <param name="file" type="data" format="csv" label="Color spec file"
          help="CSV file with 'deme' and 'color' columns, specifying what color (as RGB) each deme should be associated with.
          Note, the default color scheme is both highly contrast and friendly for most color-blind individuals."/>
      </when>
    </conditional>

    <param name="custom_pact_settings" type="data" format="txt" label="Custom PACT spec" optional="true"
      help="Not required. You can specify a custom PACT file if you would like to perform some custom anlayses.
      If you do, results will be place in the 'Full data' folder/archive."/>

  </inputs>

  <outputs>
    <data name="figures" format="pdf" label="PACT figures"/>
    <data name="full_data" format="txt" label="Full data">
      <discover_datasets pattern="__designation__" ext="txt" directory="raw_data" visible="true"/>
    </data>
  </outputs>

  <configfiles>
    <configfile name="config">

TREEFILE="${treefile}"

TIP_SELECTION_METHOD="${tip_selection.method}"
#if $tip_selection.method == "deme"
DEME="${tip_selection.deme}"
#else if $tip_selection.method == "names"
TIP_NAMES="${tip_selection.names}"
#else if $tip_selection.method == "file"
TIP_FILE="${tip_selection.names}"
#end if

TIME_RANGE_SELECTOR="${time_range.selector}"
#if ${time_range.selector} == "custom"
TIME_RANGE_START="${time_range.start}"
TIME_RANGE_END="${time_range.end}"
#end if

COLOR_SELECTOR="${color.selector}"
#if $color.selector == "brewer"
COLOR_BREWER="${color.brewer}"
#else
COLOR_FILE="${color.file}"
#end if

#if str($custom_pact_settings) != "None"
CUSTOM_PACT_SETTINGS="${custom_pact_settings}"
#else
CUSTOM_PACT_SETTINGS=""
#end if

    </configfile>
  </configfiles>

  <!-- The contents of the help tag is parsed as reStructuredText. Please see
       help-template.rst for examples of commonly-used sections in other Galaxy
       tools. -->
  <help>

.. class:: infomark

What it does
------------

This runs PACT for an Argo Navis analysis.
PACT (Posterior Analysis of Coalescent Trees), as the name suggests, is a tool for analyzing the tree file output of an Argo
Navis BEAST run.
It is an impressive tool, with many powerful analytic features, but we'll only focus on a core subset in this wrapper of the tool.

The key features of PACT that make it so powerful are its vast range of statistics and metrics which can be computed, coupled with
it's ability to restrict these metrics to a subset of the tree ancestry, both in time and in tree tips.
These features make it possible to ask very pointed questions out of a complicated data set.
For instance, imagine you have virus sequences from a number of host species;
You might want to find out what the ancestry looks like of the viruses in species A.
In particular, you might want to know what population(s) the virus in species A was in just before ending there.
With PACT, you can simply subset to the viruses in species A to invetigate this, and look at any number of statistics for them.

While PACT has many different analyses and statistics you can perform, here we focus on a select few.
We look at:

* **Skyline proportions**: These look at the ancestral proportions associated with each deme as we look back towards the root.
* **Migrate rates**: These are estimates with bounds of the rate of migration between each pair of demes.
* **Maximum likelyhood reconstruction**: The most likley tree and acestral demestate history in the posterior.
* **Other miscelaneous stats**: TMCA, etc.

We also let you restrict the tree to any tip set or temporal range you like.

If you would like to run other analyses, you can take a look at the `PACT documentation`_.
While this tool doesn't support plotting functionality for more advanced analyses, you can place your own PACT file in this tool,
get the results in the output zip file and do what you like with them.

Output files
------------

This tool outputs two files:

* **PACT figures**: A collection of figures representing the results for these analyses.
* **All files**: A collection of any other files output by PACT.

.. _PACT documentation: https://github.com/trvrb/PACT/blob/master/pact_manual.pdf?raw=true


Citation
--------

Should cite the upcoming AstV paper and BEAST and Trevor's flu paper


  </help>
</tool>
