<tool id="ARGO_pact_run" name="Run PACT" version="1.0.0">
  <description>Analyze Argo Navis BEAST run using PACT</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <command interpreter="bash">
    pact.sh ${config}
  </command>
  <stdio>
    <expand macro="basic_errors"/>
  </stdio>
  <inputs>

    <!--XXX need to make this optional-->
    <param name="treefile" type="data" format="txt" label="BEAST treefile"
      help="This should be the 'BEAST treefile' from your most recent run of BEAST.
      If you did a 'Resume' run, you should use the 'Trimmed' treefile."/>

    <param name="figures_title" type="text" label="Figures title" value="Argo Navis PACT Results"
      help="This string will be set as the title of the PDF figure file returned by this tool.
      Feel free to customize to help you keep track of your files/figures."/>

    <conditional name="tip_selection">
      <param name="method" type="select" label="Tip selection method"
        help="You may optionally choose to restrict these PACT analyses to a subset of the sequences.
        By default, all tips are included in the analysis.">
        <option value="all" selected="true">All tips (no subsetting)</option>
        <option value="deme">Select By Deme</option>
        <option value="names">Space separated tip names</option>
        <option value="file">Tip name file</option>
      </param>
      <when value="deme">
        <param name="deme" type="text" value="" label="Deme" help="Restrict analyses to the specified deme."/>
      </when>
      <when value="names">
        <param name="tip_name" type="text" value="" label="Tip names"
          help="Restrict analyses to the specified tip names (space separated)."/>
      </when>
      <when value="file">
        <param name="file" type="data" format="txt" label="Tip names file"
          help="A file with one tip name per line."/>
      </when>
    </conditional>

    <conditional name="time_range">
      <param name="selector" type="select" label="Time range"
        help="As with the Tip selection, you have the choice of restricting the anlayses to a particular time
        range wihtin the tree.">
        <option value="all" selected="true">Don't restrict time range</option>
        <option value="mrca">Time to MRCA of selected tips</option>
        <option value="custom">Custom time range</option>
      </param>
      <when value="all"/>
      <when value="mrca"/>
      <when value="custom">
        <param name="start" type="float" value="1.0" label="Start time"
          help="The age of the oldest ancestry which should be considered (as a positive number)."/>
        <param name="end" type="float" value="0.0" label="End time" optional="true"
          help="The age of the most recent ancestry which should be considered (as a non-negative number)."/>
      </when>
    </conditional>

    <conditional name="color">
      <param name="selector" type="select" label="Color specification"
        help="By default, the colors used in plots are automatically chosen for you.
        However, you can either specify your own semi-automatic color scheme using Colorbrewer, or
        for full control a CSV file mapping demes to colors.">
        <option value="brewer" selected="true">Color brewer spec</option>
        <option value="file">Color spec file</option>
      </param>
      <when value="brewer">
        <param name="brewer" type="text" value="RdBu" label="Deme and optionally date information"
          help="A valid colorbrewer2 color scheme name. See http://colorbrewer2.org/ for details."/>
      </when>
      <when value="file">
        <param name="file" type="data" format="csv" label="Color spec file"
          help="CSV file with 'deme' and 'color' columns, specifying what color (as RGB) each deme should be associated with.
          Note, the default color scheme is both highly contrast and friendly for most color-blind individuals."/>
      </when>
    </conditional>

    <param name="custom_pact_settings" type="data" format="txt" label="Custom PACT spec" optional="true"
      help="Not required. You can specify a custom PACT file if you would like to perform some custom anlayses.
      If you do, results will be place in the 'Full data' folder/archive."/>

  </inputs>

  <outputs>
    <data name="figures" format="pdf" label="PACT figures"/>
    <data name="full_data" format="txt" label="Full data">
      <discover_datasets pattern="__designation__" ext="txt" directory="working_dir" visible="true"/>
    </data>
  </outputs>

  <configfiles>
    <configfile name="config">

TREEFILE="${treefile}"

FIGURES_TITLE="${figures_title}"

TIP_SELECTION_METHOD="${tip_selection.method}"
#if $tip_selection.method == "deme"
DEME="${tip_selection.deme}"
#else if $tip_selection.method == "names"
TIP_NAMES="${tip_selection.names}"
#else if $tip_selection.method == "file"
TIP_FILE="${tip_selection.names}"
#end if

TIME_RANGE_SELECTOR="${time_range.selector}"
#if $time_range.selector == "custom"
TIME_RANGE_START="${time_range.start}"
#if str($time_range.end) != "None"
TIME_RANGE_END="${time_range.end}"
#else
TIME_RANGE_END=""
#end if
#end if

COLOR_SELECTOR="${color.selector}"
#if $color.selector == "brewer"
COLOR_BREWER="${color.brewer}"
#else
COLOR_FILE="${color.file}"
#end if

#if str($custom_pact_settings) != "None"
CUSTOM_PACT_SETTINGS="${custom_pact_settings}"
#else
CUSTOM_PACT_SETTINGS=""
#end if


FIGURES="${figures}"

    </configfile>
  </configfiles>

  <!-- The contents of the help tag is parsed as reStructuredText. Please see
       help-template.rst for examples of commonly-used sections in other Galaxy
       tools. -->
  <help>

.. class:: infomark

What it does
------------

This runs PACT for an Argo Navis analysis.
PACT (Posterior Analysis of Coalescent Trees) is a tool for analyzing the tree file output of an Argo Navis BEAST run.
While PACT is very powerful and flexible, it can be challenging to get started.
The Argo Navis wrapper automates a core set of PACT features, making it easy to operate for beginners.


How PACT works
--------------

PACTS power and flexibility is due largely to it's combination of

1. A wide range of statistics
2. Ability to subset the posterior trees, to focus on statistics related to specific questions
3. The above features compose

This means you can ask very ponited question about particular aspects of your evolutionary histories.
For example, if a virus has infected a several populations, you might be interested in where the viruses infecting one of them came from.
To determine this, you could hone in on the parts of the tree leading to the population of interest, and perhaps even restrict to time
window around when transmission into that group occured.
Within the context of this restriction, you could look at the proportions of tree length associated with each population, across all of
the trees in the posterior sample [XXX add reference to simple posterior explanation?].
Additionally, you could analyze within this restrictions the number of transmissions into the population of interest from each of the
other populations, and even estimate the rate of such transmissions.


What Argo Navis' PACT wrapper produces
--------------------------------------

Again, while PACT is a very powerful and versitile tool, for the sake of making it easier to use, we focus on a limited set of functionality.
Specifically, we produce a single PDF document with several plots and figures, and a table of statistics, as well as all of the raw data files
produced by PACT in case you'd like to do something more custom with them.

The following figures are produced in the output PDF file:

1. **Maximumum likelihood ancestral state tree**: This is the tree from the posterior trees with the highest likelihood.
   It is colored by deme, and shows one possible history of how the discrete trait may have evolved along with the molecular sequences.
   Do keep in mind though, this is only the *most likely* evolutionary course of the molecules and demes under study.
   It's possible the rest of the posterior sample looks quite different, and this should be taken into account when analyzing results.
   This tree is provided as a way of building some intuition about the data, and providing threads you can explore more formally with other tools.
2. **Skyline proportions**: In the section above about *How PACT works*, we described how you could look at the population proportions for a
   particular portion of the tree are distributed.
   We can take this one step further by using the ``skyline`` functionality of PACT, which enables us to compute a statistic for many different
   small time windows at once.
   By combining these windows, we get a picture of how the proportions are shifting over time.
3. **Migration rates**: As mentioned above, migration rates can be estimated based on the posterior trees.
   This is graphically represented via a table of boxplots, representing the mean and 95% confidence intervals of the migration rates to and
   from each population.
   The rows of this table correpsond to migration "origin", and the columns correpond to "destination".
   Additionally, the boxes are colored by migration origin, with the same scheme as used for other plots.
4. **Additional statistics**: Additional statistics are presented in textual table format.


Argo Navis PACT controls
------------------------

All you need in order to run the PACT tool is the treefile output from your BEAST run.
Note that if you have done a *resume* run, you should use the **trimmed** version of the treefile, so PACT doesn't get too bogged down
with a large data set.
In addition to the data though, you can specify:

1. **Figure title**: A title to display at the top of your PDF document, for help in organizing.
2. **Tip selection**: Restrict analyses to a particular set of tree tips.
   You're choices here include:
   a. leaving all tree tips in the analysis
   b. subsetting to just the tree tips corresponding to a specific deme
   c. subsetting to an arbitrary collection of tree tips via text field
   d. subsetting to an arbitrary collection of tree tips, as specified by an input file
3. **Temporal select**: Restrict analyses to a particular time window.
   You can specify either or both of start time and stop time.
   By default, analyses consider the entire history of the posterior trees, and the skyline proportions go as far back as the mean TMRCA.
4. **Color specification**: You can customize the color scheme used in the graphics, either using a `ColorBrewer`_ pallete, or a CSV file
   mapping demes to RGB color specifications

If you would like to run more customized analyses, you can also specify a custom PACT config file.
However, this tool does not support the PDF output for more customized analyses;
You will instead get individual textual output files, which you will have to process/interpret as you see fit.
For guidance in this, we recommend you take a look at the `PACT documentation`_.


.. _PACT documentation: https://github.com/trvrb/PACT/blob/master/pact_manual.pdf?raw=true
.. _ColorBrewer: http://colorbrewer2.org


Citation
--------

Should cite the upcoming AstV paper and BEAST and Trevor's flu paper


  </help>
</tool>
